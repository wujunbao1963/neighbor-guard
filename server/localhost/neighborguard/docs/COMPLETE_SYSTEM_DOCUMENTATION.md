# NeighborGuard å®Œæ•´ç³»ç»Ÿæ–‡æ¡£
## ç¤¾åŒºå®‰é˜²åä½œå¹³å° - Phase 1 + Phase 2

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šäº§å“æ¦‚è¿°

## 1.1 äº§å“æ„¿æ™¯

NeighborGuard æ˜¯ä¸€ä¸ªæ™ºèƒ½ç¤¾åŒºå®‰é˜²åä½œå¹³å°ï¼Œæ—¨åœ¨ï¼š

1. **æ™ºèƒ½åŒ–å®‰é˜²ç›‘æ§**ï¼šé€šè¿‡å¤šä¼ æ„Ÿå™¨èåˆæŠ€æœ¯ï¼Œå°†å„ç§ IoT è®¾å¤‡ï¼ˆé—¨çª—ä¼ æ„Ÿå™¨ã€æ‘„åƒå¤´ã€çƒŸé›¾æ¢æµ‹å™¨ç­‰ï¼‰çš„ä¿¡å·æ™ºèƒ½ç»„åˆï¼Œç”Ÿæˆé«˜å‡†ç¡®ç‡çš„å®‰å…¨äº‹ä»¶
2. **ç¤¾åŒºåä½œäº’åŠ©**ï¼šé€šè¿‡ Circleï¼ˆä¿¡ä»»åœˆï¼‰æœºåˆ¶ï¼Œè®©å®¶åº­æˆå‘˜å’Œå¯ä¿¡é‚»å±…èƒ½å¤Ÿå…±åŒç›‘æ§å’Œå“åº”å®‰å…¨äº‹ä»¶
3. **éšç§ä¼˜å…ˆè®¾è®¡**ï¼šåŸºäºåŒºåŸŸéšç§çº§åˆ«çš„æ™ºèƒ½é€šçŸ¥ç­–ç•¥ï¼Œç¡®ä¿åœ¨æä¾›å®‰å…¨ä¿æŠ¤çš„åŒæ—¶å°Šé‡éšç§

## 1.2 ç›®æ ‡ç”¨æˆ·

- **ä¸»è¦ç”¨æˆ·**ï¼šæ‹¥æœ‰æ™ºèƒ½å®¶å±…è®¾å¤‡çš„ç‹¬æ ‹ä½å®…ä¸šä¸»
- **æ¬¡è¦ç”¨æˆ·**ï¼šå®¶åº­æˆå‘˜ã€ä¿¡ä»»çš„é‚»å±…ã€äº²å‹

## 1.3 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | Phase 1 | Phase 2 |
|---------|---------|---------|
| ç”¨æˆ·è®¤è¯ | âœ… é‚®ç®± OTP ç™»å½• | - |
| Circle ç¤¾åŒºåœˆå­ | âœ… åˆ›å»ºã€åŠ å…¥ã€æˆå‘˜ç®¡ç† | - |
| æˆå‘˜è§’è‰²æƒé™ | âœ… 5ç§è§’è‰²ç­‰çº§ | - |
| äº‹ä»¶ç®¡ç† | âœ… æ‰‹åŠ¨åˆ›å»º/æŸ¥çœ‹ | âœ… è‡ªåŠ¨èåˆç”Ÿæˆ |
| åŒºåŸŸç®¡ç† | âœ… Zone é…ç½® | âœ… éšç§çº§åˆ« |
| ä¼ æ„Ÿå™¨é›†æˆ | âœ… Home Assistant | âœ… 21ç§ä¼ æ„Ÿå™¨ç±»å‹ |
| House Mode | âœ… 4ç§æ¨¡å¼ | âœ… æ¨¡å¼æ„ŸçŸ¥è§„åˆ™ |
| é€šçŸ¥ç³»ç»Ÿ | âœ… æ¨é€é€šçŸ¥ | âœ… æ™ºèƒ½é€šçŸ¥ç­–ç•¥ |
| èåˆå¼•æ“ | - | âœ… 16æ¡èåˆè§„åˆ™ |
| ML åé¦ˆ | - | âœ… åé¦ˆæ”¶é›†ç³»ç»Ÿ |

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šCircle ç¤¾åŒºäº’åŠ©ç³»ç»Ÿ (Phase 1)

## 2.1 Circle æ¦‚å¿µ

Circleï¼ˆä¿¡ä»»åœˆï¼‰æ˜¯ NeighborGuard çš„æ ¸å¿ƒç¤¾äº¤å•å…ƒï¼Œä»£è¡¨ä¸€ä¸ªå®‰å…¨ç›‘æ§ç¾¤ç»„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Circle                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  OWNER  â”‚   â”‚HOUSEHOLDâ”‚   â”‚NEIGHBOR â”‚   â”‚RELATIVE â”‚     â”‚
â”‚  â”‚  ä¸šä¸»   â”‚   â”‚å®¶åº­æˆå‘˜ â”‚   â”‚ é‚»å±…    â”‚   â”‚ äº²å‹    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚             â”‚             â”‚             â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚   Home    â”‚                            â”‚
â”‚                    â”‚  æˆ¿å±‹é…ç½®  â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                          â”‚                                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚          â”‚               â”‚               â”‚                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚   Zone    â”‚  â”‚   Zone    â”‚  â”‚   Zone    â”‚            â”‚
â”‚    â”‚  å‰é—¨     â”‚  â”‚  åé™¢     â”‚  â”‚  å®¢å…     â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 æˆå‘˜è§’è‰²ä½“ç³»

### è§’è‰²å®šä¹‰

| è§’è‰² | ä»£ç  | æè¿° | å…¸å‹ç”¨æˆ· |
|------|------|------|----------|
| **OWNER** | ä¸šä¸» | Circle åˆ›å»ºè€…ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ | æˆ¿å±‹ä¸šä¸» |
| **HOUSEHOLD** | å®¶åº­æˆå‘˜ | å®Œå…¨è®¿é—®æƒé™ï¼Œå¯ç®¡ç†å¤§éƒ¨åˆ†è®¾ç½® | é…å¶ã€æˆå¹´å­å¥³ |
| **NEIGHBOR** | é‚»å±… | å¯æŸ¥çœ‹äº‹ä»¶å¹¶ååŠ©å“åº” | ä¿¡ä»»çš„é‚»å±… |
| **RELATIVE** | äº²å‹ | å¯æŸ¥çœ‹äº‹ä»¶å’Œæ¥æ”¶é€šçŸ¥ | è¿œç¨‹äº²å±ã€æœ‹å‹ |
| **OBSERVER** | è§‚å¯Ÿè€… | ä»…å¯æŸ¥çœ‹ä½æ•æ„Ÿåº¦ä¿¡æ¯ | ä¸´æ—¶è®¿å®¢ |

### æƒé™çŸ©é˜µ

| æƒé™ | OWNER | HOUSEHOLD | NEIGHBOR | RELATIVE | OBSERVER |
|------|-------|-----------|----------|----------|----------|
| åˆ›å»ºäº‹ä»¶ | âœ… | âœ… | âœ… | âŒ | âŒ |
| æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶ | âœ… | âœ… | âœ… | âœ… | éƒ¨åˆ† |
| æŸ¥çœ‹äº‹ä»¶åª’ä½“ | âœ… | âœ… | âœ… | å¯é…ç½® | âŒ |
| è§£å†³äº‹ä»¶ | âœ… | âœ… | âŒ | âŒ | âŒ |
| ç®¡ç† Zone | âœ… | âœ… | âŒ | âŒ | âŒ |
| ç®¡ç†ä¼ æ„Ÿå™¨ | âœ… | âœ… | âŒ | âŒ | âŒ |
| é‚€è¯·æˆå‘˜ | âœ… | âœ… | âŒ | âŒ | âŒ |
| ç§»é™¤æˆå‘˜ | âœ… | âŒ | âŒ | âŒ | âŒ |
| ä¿®æ”¹ House Mode | âœ… | âœ… | âŒ | âŒ | âŒ |
| åˆ é™¤ Circle | âœ… | âŒ | âŒ | âŒ | âŒ |

### é€šçŸ¥åå¥½è®¾ç½®

æ¯ä¸ªæˆå‘˜å¯ç‹¬ç«‹é…ç½®é€šçŸ¥æ¥æ”¶åå¥½ï¼š

```javascript
CircleMember {
  notifyOnHighSeverity: Boolean   // æ¥æ”¶é«˜ä¸¥é‡åº¦äº‹ä»¶é€šçŸ¥
  notifyOnMediumSeverity: Boolean // æ¥æ”¶ä¸­ç­‰ä¸¥é‡åº¦äº‹ä»¶é€šçŸ¥
  notifyOnLowSeverity: Boolean    // æ¥æ”¶ä½ä¸¥é‡åº¦äº‹ä»¶é€šçŸ¥
  canViewAllEventMedia: Boolean   // æ˜¯å¦å¯æŸ¥çœ‹äº‹ä»¶åª’ä½“
}
```

## 2.3 Circle å·¥ä½œæµç¨‹

### åˆ›å»º Circle

```
ç”¨æˆ·æ³¨å†Œ â†’ åˆ›å»º Circle â†’ é…ç½® Home â†’ æ·»åŠ  Zone â†’ é›†æˆä¼ æ„Ÿå™¨ â†’ é‚€è¯·æˆå‘˜
```

### é‚€è¯·æˆå‘˜åŠ å…¥

```
OWNER/HOUSEHOLD å‘é€é‚€è¯· â†’ è¢«é‚€è¯·è€…æ”¶åˆ°é‚®ä»¶ â†’ ç‚¹å‡»é“¾æ¥æ³¨å†Œ/ç™»å½• â†’ è‡ªåŠ¨åŠ å…¥ Circle
```

### äº‹ä»¶åä½œæµç¨‹

```
ä¼ æ„Ÿå™¨è§¦å‘ â†’ ç”Ÿæˆäº‹ä»¶ â†’ é€šçŸ¥æ‰€æœ‰æˆå‘˜ â†’ æˆå‘˜æŸ¥çœ‹/è¯„è®º â†’ OWNER/HOUSEHOLD è§£å†³
     â”‚                        â”‚
     â”‚                        â”œâ”€â”€ NEIGHBOR å¯æ·»åŠ è¯„è®º/ç…§ç‰‡
     â”‚                        â””â”€â”€ RELATIVE å¯æŸ¥çœ‹çŠ¶æ€
     â”‚
     â””â”€â”€ åŸºäºè§’è‰²å’Œé€šçŸ¥åå¥½è¿‡æ»¤é€šçŸ¥æ¥æ”¶è€…
```

## 2.4 æ•°æ®æ¨¡å‹

### Circle è¡¨

```prisma
model Circle {
  id          String    @id @default(uuid())
  ownerId     String    // åˆ›å»ºè€…ç”¨æˆ·ID
  displayName String    // Circle åç§°
  createdAt   DateTime
  deletedAt   DateTime? // è½¯åˆ é™¤

  owner        User           @relation("CircleOwner")
  members      CircleMember[]
  home         Home?
  zones        Zone[]
  events       Event[]
  integrations Integration[]
  sensors      Sensor[]
}
```

### CircleMember è¡¨

```prisma
model CircleMember {
  id                     String     @id @default(uuid())
  circleId               String
  userId                 String
  role                   MemberRole // OWNER, HOUSEHOLD, NEIGHBOR, RELATIVE, OBSERVER
  displayName            String?    // åœ¨æ­¤ Circle ä¸­æ˜¾ç¤ºçš„åç§°
  notifyOnHighSeverity   Boolean    @default(true)
  notifyOnMediumSeverity Boolean    @default(true)
  notifyOnLowSeverity    Boolean    @default(false)
  canViewAllEventMedia   Boolean    @default(true)
  joinedAt               DateTime
  leftAt                 DateTime?  // ç¦»å¼€æ—¶é—´

  @@unique([circleId, userId])  // ä¸€ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ª Circle åªèƒ½æœ‰ä¸€ä¸ªæˆå‘˜èº«ä»½
}
```

## 2.5 API ç«¯ç‚¹

### Circle ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | æ‰€éœ€è§’è‰² |
|------|------|------|----------|
| /api/circles | GET | è·å–ç”¨æˆ·æ‰€æœ‰ Circles | ä»»æ„æˆå‘˜ |
| /api/circles | POST | åˆ›å»ºæ–° Circle | å·²è®¤è¯ç”¨æˆ· |
| /api/circles/:id | GET | è·å– Circle è¯¦æƒ… | Circle æˆå‘˜ |
| /api/circles/:id | PUT | æ›´æ–° Circle ä¿¡æ¯ | OWNER |
| /api/circles/:id | DELETE | åˆ é™¤ Circle | OWNER |

### æˆå‘˜ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | æ‰€éœ€è§’è‰² |
|------|------|------|----------|
| /api/circles/:id/members | GET | è·å–æˆå‘˜åˆ—è¡¨ | Circle æˆå‘˜ |
| /api/circles/:id/members/invite | POST | é‚€è¯·æ–°æˆå‘˜ | OWNER, HOUSEHOLD |
| /api/circles/:id/members/:memberId | PUT | æ›´æ–°æˆå‘˜è§’è‰² | OWNER |
| /api/circles/:id/members/:memberId | DELETE | ç§»é™¤æˆå‘˜ | OWNER |
| /api/circles/:id/leave | POST | ä¸»åŠ¨ç¦»å¼€ | é OWNER æˆå‘˜ |

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šHome ä¸ Zone é…ç½®

## 3.1 Home é…ç½®

æ¯ä¸ª Circle æœ‰ä¸”åªæœ‰ä¸€ä¸ª Homeï¼ˆæˆ¿å±‹é…ç½®ï¼‰ï¼š

```prisma
model Home {
  id               String
  circleId         String     @unique
  displayName      String
  
  // åœ°å€ä¿¡æ¯
  country          String     @default("CA")
  region           String     // çœ/å·
  city             String
  postalCode       String
  addressLine1     String?
  
  // æˆ¿å±‹ç‰¹å¾
  houseType        HouseType  // DETACHED, SEMI, ROW, APARTMENT
  hasDriveway      Boolean    @default(true)
  hasBackYard      Boolean    @default(true)
  hasBackAlley     Boolean    @default(false)
  
  // House Mode è®¾ç½®
  houseMode        HouseMode  @default(DISARMED)
  nightModeAuto    Boolean    @default(false)
  nightModeStart   String     @default("22:00")
  nightModeEnd     String     @default("06:00")
  nightModeHighOnly Boolean   @default(false)
}
```

## 3.2 House Modeï¼ˆæˆ¿å±‹æ¨¡å¼ï¼‰

| æ¨¡å¼ | å›¾æ ‡ | æè¿° | å®‰å…¨çº§åˆ« |
|------|------|------|----------|
| **DISARMED** | ğŸ”“ | å®Œå…¨è§£é™¤è­¦æˆ’ | æœ€ä½ - ä»…å®‰å…¨äº‹ä»¶ |
| **HOME** | ğŸ  | åœ¨å®¶æ¨¡å¼ | ä¸­ç­‰ - å‘¨è¾¹ç›‘æ§ |
| **AWAY** | ğŸ›¡ï¸ | ç¦»å®¶æ¨¡å¼ | é«˜ - å…¨é¢ç›‘æ§ |
| **NIGHT** | ğŸŒ™ | å¤œé—´æ¨¡å¼ | æœ€é«˜ - å¢å¼ºæ•æ„Ÿåº¦ |

## 3.3 Zoneï¼ˆç›‘æ§åŒºåŸŸï¼‰

### Zone ç±»å‹

```
å…¥å£ç‚¹ (Entry Points)
â”œâ”€â”€ FRONT_DOOR      å‰é—¨
â”œâ”€â”€ BACK_DOOR       åé—¨
â”œâ”€â”€ SIDE_DOOR       ä¾§é—¨
â””â”€â”€ GARAGE_ENTRANCE è½¦åº“å…¥å£

æˆ·å¤–åŒºåŸŸ (Outdoor)
â”œâ”€â”€ FRONT_YARD      å‰é™¢
â”œâ”€â”€ BACK_YARD       åé™¢
â”œâ”€â”€ SIDE_YARD       ä¾§é™¢
â”œâ”€â”€ DRIVEWAY        è½¦é“
â”œâ”€â”€ PORCH           é—¨å»Š
â””â”€â”€ PATIO           éœ²å°

è¾¹ç•ŒåŒºåŸŸ (Boundary)
â”œâ”€â”€ STREET_FRONT    è¡—é“å‰æ–¹
â”œâ”€â”€ ALLEY_BEHIND    åå··
â”œâ”€â”€ SIDE_ALLEY      ä¾§é“
â””â”€â”€ FENCE_LINE      å›´æ 

å®¤å†…åŒºåŸŸ (Interior)
â”œâ”€â”€ LIVING_ROOM     å®¢å…
â”œâ”€â”€ HALLWAY         èµ°å»Š
â”œâ”€â”€ STAIRS          æ¥¼æ¢¯
â”œâ”€â”€ GARAGE_INTERIOR è½¦åº“å†…éƒ¨
â””â”€â”€ BASEMENT        åœ°ä¸‹å®¤
```

### éšç§çº§åˆ« (Phase 2)

| çº§åˆ« | æè¿° | ç¤ºä¾‹åŒºåŸŸ | å¯ç–‘åˆ¤å®šé˜ˆå€¼ |
|------|------|----------|--------------|
| **PUBLIC** | å…¬å…±å¯è§ | è¡—é“ã€äººè¡Œé“ | ä¸åˆ¤å®šä¸ºå¯ç–‘ |
| **SEMI_PRIVATE** | åŠç§å¯† | å‰é™¢ã€è½¦é“ | è¾ƒé«˜å®¹å¿åº¦ |
| **PRIVATE** | ç§å¯† | åé™¢ã€ä¾§é™¢ | 20ç§’åœç•™=å¯ç–‘ |
| **RESTRICTED** | é™åˆ¶åŒºåŸŸ | å®¤å†…ã€å…¥å£ | ç«‹å³è­¦æŠ¥ |

---

# ç¬¬å››éƒ¨åˆ†ï¼šä¼ æ„Ÿå™¨é›†æˆ (Phase 1B + Phase 2)

## 4.1 æ”¯æŒçš„ä¼ æ„Ÿå™¨ç±»å‹

### Phase 1B åŸºç¡€ä¼ æ„Ÿå™¨

| ç±»å‹ | ä»£ç  | æè¿° |
|------|------|------|
| é—¨çª—ä¼ æ„Ÿå™¨ | DOOR_CONTACT | é—¨çª—å¼€åˆçŠ¶æ€ |
| PIR è¿åŠ¨ | PIR | è¢«åŠ¨çº¢å¤–è¿åŠ¨æ¢æµ‹ |
| ç»ç’ƒç ´ç¢ | GLASS_BREAK | ç»ç’ƒç ´ç¢å£°éŸ³/æŒ¯åŠ¨ |
| æŒ¯åŠ¨ä¼ æ„Ÿå™¨ | VIBRATION | ç‰©ç†æŒ¯åŠ¨æ£€æµ‹ |
| çƒŸé›¾æ¢æµ‹ | SMOKE | çƒŸé›¾æŠ¥è­¦ |
| æ°´æµ¸ä¼ æ„Ÿå™¨ | WATER_LEAK | æ¼æ°´æ£€æµ‹ |

### Phase 2 æ‰©å±•ä¼ æ„Ÿå™¨

| ç±»å‹ | ä»£ç  | æè¿° |
|------|------|------|
| çª—æˆ·ä¼ æ„Ÿå™¨ | WINDOW_CONTACT | çª—æˆ·ä¸“ç”¨ä¼ æ„Ÿå™¨ |
| æ™ºèƒ½é” | LOCK | æ™ºèƒ½é—¨é”çŠ¶æ€ |
| CO æ¢æµ‹å™¨ | CO_DETECTOR | ä¸€æ°§åŒ–ç¢³æ£€æµ‹ |
| æ‘„åƒå¤´è¿åŠ¨ | CAMERA_MOTION | æ‘„åƒå¤´åŸºç¡€è¿åŠ¨ |
| æ‘„åƒå¤´äººå½¢ | CAMERA_PERSON | AI äººå½¢è¯†åˆ« |
| æ‘„åƒå¤´è½¦è¾† | CAMERA_VEHICLE | AI è½¦è¾†è¯†åˆ« |
| æ‘„åƒå¤´åŒ…è£¹ | CAMERA_PACKAGE | AI åŒ…è£¹è¯†åˆ« |
| æ‘„åƒå¤´åŠ¨ç‰© | CAMERA_ANIMAL | AI åŠ¨ç‰©è¯†åˆ« |
| å¼‚å¸¸å£°éŸ³ | MIC_UNUSUAL_NOISE | éŸ³é¢‘å¼‚å¸¸æ£€æµ‹ |
| å©´å„¿å“­å£° | MIC_BABY_CRY | å©´å„¿å“­å£°æ£€æµ‹ |
| éŸ³é¢‘ç»ç¢ | MIC_GLASS_BREAK | éŸ³é¢‘ç»ç’ƒç ´ç¢æ£€æµ‹ |

## 4.2 Home Assistant é›†æˆ

### Webhook é…ç½®

```yaml
# Home Assistant automation.yaml
automation:
  - alias: "NeighborGuard - Door Sensor"
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door
    action:
      - service: rest_command.neighborguard_webhook
        data:
          entity_id: "{{ trigger.entity_id }}"
          state: "{{ trigger.to_state.state }}"
          friendly_name: "{{ trigger.to_state.attributes.friendly_name }}"

rest_command:
  neighborguard_webhook:
    url: "https://your-domain.com/api/webhooks/ha/{webhook_token}"
    method: POST
    content_type: "application/json"
    payload: >
      {
        "entity_id": "{{ entity_id }}",
        "state": "{{ state }}",
        "attributes": {
          "friendly_name": "{{ friendly_name }}"
        }
      }
```

### Webhook æ•°æ®æ ¼å¼

```json
{
  "entity_id": "binary_sensor.front_door",
  "state": "on",
  "attributes": {
    "device_class": "door",
    "friendly_name": "Front Door"
  },
  "context": {
    "id": "unique_context_id",
    "timestamp": "2025-12-12T10:30:00Z"
  },
  // Phase 2: å¯é€‰ AI æ ‡å¿—
  "flags": ["person", "loitering", "intrusion"]
}
```

---

# ç¬¬äº”éƒ¨åˆ†ï¼šèåˆå¼•æ“ (Phase 2)

## 5.1 æ¦‚è¿°

FusionEngine æ˜¯ Phase 2 çš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š
1. æ¥æ”¶åŸå§‹ä¼ æ„Ÿå™¨äº‹ä»¶
2. åˆ›å»º/æ›´æ–°è¡Œä¸ºè½¨è¿¹ (Track)
3. æ ¹æ®è§„åˆ™è¯„ä¼°ç”Ÿæˆå®‰å…¨äº‹ä»¶
4. åº”ç”¨é€šçŸ¥ç­–ç•¥

## 5.2 å¤„ç†æµç¨‹

```
ä¼ æ„Ÿå™¨è§¦å‘
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webhook æ¥æ”¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»º SensorEvent â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Track ç®¡ç†     â”‚â”€â”€â”€â”€â–¶â”‚ è®¡ç®—åœç•™æ—¶é—´    â”‚
â”‚ (æŸ¥æ‰¾/åˆ›å»ºè½¨è¿¹)  â”‚     â”‚ (å„éšç§çº§åˆ«)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™è¯„ä¼°       â”‚  â—€â”€â”€ æŒ‰ä¼˜å…ˆçº§é¡ºåºè¯„ä¼°
â”‚ (16æ¡èåˆè§„åˆ™)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆ Event     â”‚
â”‚ (ç±»å‹+ä¸¥é‡åº¦)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥ç­–ç•¥       â”‚  â—€â”€â”€ åŸºäº House Mode
â”‚ (å†³å®šé€šçŸ¥çº§åˆ«)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€æ¨é€é€šçŸ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.3 Trackï¼ˆè¡Œä¸ºè½¨è¿¹ï¼‰

Track ç”¨äºå…³è”æ¥è‡ªåŒä¸€ç§»åŠ¨å¯¹è±¡çš„å¤šä¸ªä¼ æ„Ÿå™¨äº‹ä»¶ï¼š

```prisma
model Track {
  id                  String
  circleId            String
  homeId              String
  objectType          ObjectType    // PERSON, VEHICLE, ANIMAL, PACKAGE, UNKNOWN
  isActive            Boolean       // è½¨è¿¹æ˜¯å¦ä»åœ¨è¿›è¡Œ
  firstSeenAt         DateTime      // é¦–æ¬¡æ£€æµ‹æ—¶é—´
  lastSeenAt          DateTime      // æœ€åæ´»åŠ¨æ—¶é—´
  
  // å„éšç§çº§åˆ«åœç•™æ—¶é—´ï¼ˆç§’ï¼‰
  dwellSecondsPublic      Int @default(0)
  dwellSecondsSemiPrivate Int @default(0)
  dwellSecondsPrivate     Int @default(0)
  dwellSecondsRestricted  Int @default(0)
  
  zonesVisited        String[]      // è®¿é—®è¿‡çš„åŒºåŸŸåˆ—è¡¨
  maxPrivacyLevel     PrivacyLevel  // åˆ°è¾¾çš„æœ€é«˜éšç§çº§åˆ«
  
  sensorEvents        SensorEvent[]
  events              Event[]
}
```

### Track é…ç½®å‚æ•°

```javascript
TRACK_WINDOW_SECONDS = 120    // è½¨è¿¹æ—¶é—´çª—å£ï¼ˆ2åˆ†é’Ÿï¼‰
TRACK_GAP_SECONDS = 60        // é—´éš”è¶…è¿‡æ­¤å€¼åˆ›å»ºæ–°è½¨è¿¹
```

## 5.4 èåˆè§„åˆ™æ¦‚è§ˆ

### è§„åˆ™ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | è§„åˆ™ID | äº‹ä»¶ç±»å‹ | è§¦å‘æ¡ä»¶ |
|--------|--------|----------|----------|
| 1 | R14 | fire_detected | çƒŸé›¾ä¼ æ„Ÿå™¨è§¦å‘ |
| 2 | R15 | co_detected | COæ¢æµ‹å™¨è§¦å‘ |
| 3 | R16 | water_leak_detected | æ°´æµ¸ä¼ æ„Ÿå™¨è§¦å‘ |
| 4-6 | R1-R3 | break_in_attempt | é—¨+å®¤å†…è¿åŠ¨ / ç»ç¢+äººå½¢ / å…¥ä¾µæ ‡å¿— |
| 7-8 | R4-R5 | perimeter_damage | ä»…ç»ç¢ / å¼ºæŒ¯åŠ¨ |
| 9-11 | R6-R8 | suspicious_person | åœç•™20ç§’+ / å¾˜å¾Šæ ‡å¿— / åé™¢æ£€æµ‹ |
| 12-14 | R9-R10B | suspicious_vehicle | è½¦è¾†åœç•™2åˆ†é’Ÿ+ / é‡å¤å‡ºç° |
| 15-16 | R12-R13 | package_* | åŒ…è£¹å‡ºç°/ç§»é™¤ |
| 17 | R99 | motion_detected | å…œåº•è¿åŠ¨æ£€æµ‹ |

### è§„åˆ™ç¤ºä¾‹ï¼šå…¥ä¾µæ£€æµ‹

```javascript
R1_BREAKIN_DOOR_PIR: {
  id: 'R1_BREAKIN_DOOR_PIR',
  name: 'Break-in: Door/Window + Indoor Motion',
  eventType: 'break_in_attempt',
  severity: 'HIGH',
  requiredModes: ['NIGHT', 'AWAY'],
  windowSeconds: 30,
  
  conditions: (events, context) => {
    // å¿…é¡»æœ‰é—¨çª—ä¼ æ„Ÿå™¨è§¦å‘
    const hasDoorSensor = events.some(e => 
      ['DOOR_CONTACT', 'WINDOW_CONTACT', 'LOCK'].includes(e.sensor?.sensorType)
    );
    // å¿…é¡»æœ‰å®¤å†…è¿åŠ¨æ£€æµ‹
    const hasIndoorMotion = events.some(e => 
      ['PIR', 'CAMERA_MOTION'].includes(e.sensor?.sensorType) &&
      ['PRIVATE', 'RESTRICTED'].includes(e.zone?.privacyLevel)
    );
    // é—¨çª—å¿…é¡»åœ¨å…¥å£åŒºåŸŸ
    const isEntryZone = events.some(e => e.zone?.isEntryPoint);
    
    return hasDoorSensor && hasIndoorMotion && isEntryZone;
  }
}
```

## 5.5 åœç•™æ—¶é—´é˜ˆå€¼

| å¯¹è±¡ç±»å‹ | é˜ˆå€¼ | ä¸¥é‡åº¦ | æè¿° |
|----------|------|--------|------|
| äºº | 20ç§’ | MEDIUM | ç§å¯†åŒºåŸŸå¯ç–‘äººå‘˜ |
| äºº (å¤œé—´/ç¦»å®¶) | 20ç§’ | HIGH | å‡çº§ä¸¥é‡åº¦ |
| è½¦è¾† | 120ç§’ | MEDIUM | è½¦è¾†å¾˜å¾Š |
| è½¦è¾† | 300ç§’ | HIGH | ä¸¥é‡è½¦è¾†å¾˜å¾Š |

## 5.6 é€šçŸ¥ç­–ç•¥çŸ©é˜µ

```
House Mode Ã— Event Severity â†’ Notification Level

              â”‚ HIGH äº‹ä»¶  â”‚ MEDIUM äº‹ä»¶ â”‚ LOW äº‹ä»¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
DISARMED      â”‚ NORMAL    â”‚ NONE       â”‚ NONE
HOME          â”‚ HIGH      â”‚ NORMAL     â”‚ NONE
AWAY          â”‚ HIGH      â”‚ HIGH       â”‚ NORMAL
NIGHT         â”‚ HIGH      â”‚ NORMAL*    â”‚ NONE

* å¦‚æœ nightModeHighOnly=trueï¼Œåˆ™ MEDIUM äº‹ä»¶ä¹Ÿä¸º NONE
```

### é€šçŸ¥çº§åˆ«è¡Œä¸º

| çº§åˆ« | è¡Œä¸º | ç”¨ä¾‹ |
|------|------|------|
| HIGH | æ¨é€ + å£°éŸ³ + æŒ¯åŠ¨ | å…¥ä¾µã€ç«ç¾ã€CO |
| NORMAL | æ™®é€šæ¨é€ | å¯ç–‘æ´»åŠ¨ã€åŒ…è£¹ |
| NONE | é™é»˜/ä¸é€šçŸ¥ | è§£é™¤è­¦æˆ’æ¨¡å¼ä¸‹çš„ä½ä¼˜å…ˆçº§äº‹ä»¶ |

---

# ç¬¬å…­éƒ¨åˆ†ï¼šML åé¦ˆç³»ç»Ÿ (Phase 2)

## 6.1 ç›®çš„

æ”¶é›†ç”¨æˆ·å¯¹äº‹ä»¶çš„åé¦ˆï¼Œä¸ºæœªæ¥çš„æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒå‡†å¤‡æ•°æ®ã€‚

## 6.2 åé¦ˆæ”¶é›†

### åé¦ˆæ ‡ç­¾

| æ ‡ç­¾ | å«ä¹‰ |
|------|------|
| FALSE_ALARM | è¯¯æŠ¥ - ç”¨æˆ·æ ‡è®°ä¸ºéçœŸå®å¨èƒ |
| USEFUL | æœ‰ç”¨ - ç”¨æˆ·ç¡®è®¤ä¸ºæœ‰ä»·å€¼çš„é€šçŸ¥ |

### åé¦ˆ API

```http
POST /api/circles/:circleId/events/:eventId/feedback
Content-Type: application/json

{
  "label": "FALSE_ALARM",
  "note": "åªæ˜¯å¿«é€’å‘˜é€è´§"
}
```

## 6.3 ç‰¹å¾å­˜å‚¨

ä¸ºæ¯ä¸ªäº‹ä»¶é¢„è®¡ç®— ML ç‰¹å¾ï¼š

```prisma
model EventMLFeature {
  eventId             String   @unique
  
  // äº‹ä»¶å±æ€§
  eventType           String
  severity            String
  
  // ä¸Šä¸‹æ–‡
  houseMode           String
  hourBucket          Int      // 0-23
  weekday             Int      // 0-6
  
  // ä¼ æ„Ÿå™¨ç»„åˆæ ‡å¿—
  hasDoorContact      Boolean
  hasInsideMotion     Boolean
  hasCameraPerson     Boolean
  hasGlassBreak       Boolean
  sensorCount         Int
  
  // è½¨è¿¹ç‰¹å¾
  hasPrivateZone      Boolean
  dwellPrivateSec     Int
  dwellTotalSec       Int
  
  // å†å²ç»Ÿè®¡ï¼ˆå®šæœŸæ›´æ–°ï¼‰
  histFalseRateType   Float?   // è¯¥äº‹ä»¶ç±»å‹çš„å†å²è¯¯æŠ¥ç‡
  histFalseRateSensor Float?   // ç›¸å…³ä¼ æ„Ÿå™¨çš„å†å²è¯¯æŠ¥ç‡
  histFalseRateHour   Float?   // è¯¥æ—¶æ®µçš„å†å²è¯¯æŠ¥ç‡
}
```

---

# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šAPI å‚è€ƒ

## 7.1 è®¤è¯

### è¯·æ±‚éªŒè¯ç 
```http
POST /api/auth/request-code
{ "email": "user@example.com" }
```

### ç™»å½•
```http
POST /api/auth/login
{ "email": "user@example.com", "code": "587585" }
```

## 7.2 Circle ç®¡ç†

### è·å–ç”¨æˆ·çš„æ‰€æœ‰ Circles
```http
GET /api/circles
Authorization: Bearer <token>
```

### åˆ›å»º Circle
```http
POST /api/circles
Authorization: Bearer <token>
{
  "displayName": "æˆ‘çš„å®¶",
  "home": {
    "displayName": "XXXè·¯XXXå·",
    "houseType": "DETACHED",
    "city": "Calgary"
  }
}
```

### é‚€è¯·æˆå‘˜
```http
POST /api/circles/:circleId/members/invite
Authorization: Bearer <token>
{
  "email": "neighbor@example.com",
  "role": "NEIGHBOR"
}
```

## 7.3 äº‹ä»¶ç®¡ç†

### è·å–äº‹ä»¶åˆ—è¡¨
```http
GET /api/circles/:circleId/events?page=1&pageSize=20&status=OPEN
Authorization: Bearer <token>
X-Circle-Id: <circleId>
```

### è·å–äº‹ä»¶è¯¦æƒ…ï¼ˆå«è½¨è¿¹ï¼‰
```http
GET /api/circles/:circleId/events/:eventId
Authorization: Bearer <token>
```

å“åº”åŒ…å«å®Œæ•´çš„ Track å’Œ SensorEvent æ•°æ®ã€‚

### æäº¤åé¦ˆ
```http
POST /api/circles/:circleId/events/:eventId/feedback
Authorization: Bearer <token>
{
  "label": "USEFUL",
  "note": "ç¡®å®æœ‰äººåœ¨é—¨å£å¾˜å¾Š"
}
```

## 7.4 House Mode

### è®¾ç½® House Mode
```http
PUT /api/circles/:circleId/home/mode
Authorization: Bearer <token>
{ "mode": "AWAY" }
```

---

# ç¬¬å…«éƒ¨åˆ†ï¼šéƒ¨ç½²æŒ‡å—

## 8.1 ç¯å¢ƒå˜é‡

```env
# æ•°æ®åº“
DATABASE_URL="postgresql://user:pass@host:5432/neighborguard"

# JWT è®¤è¯
JWT_SECRET="your-secure-secret-key"
JWT_ACCESS_EXPIRES_IN="15m"
JWT_REFRESH_EXPIRES_IN="7d"

# è®¤è¯ç 
AUTH_CODE_EXPIRES_MINUTES=10
AUTH_TEST_MODE=false

# æ¨é€é€šçŸ¥
APNS_KEY_ID="your-apns-key"
APNS_TEAM_ID="your-team-id"
APNS_BUNDLE_ID="com.company.neighborguard"

# æœåŠ¡å™¨
PORT=5000
NODE_ENV=production
```

## 8.2 éƒ¨ç½²æ­¥éª¤

1. é…ç½® PostgreSQL æ•°æ®åº“
2. è®¾ç½®ç¯å¢ƒå˜é‡
3. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š`npx prisma migrate deploy`
4. æ„å»ºå‰ç«¯ï¼š`cd frontend && npm run build`
5. å¯åŠ¨æœåŠ¡å™¨ï¼š`node backend/server.js`

## 8.3 Home Assistant é›†æˆé…ç½®

1. åœ¨ NeighborGuard ä¸­ï¼šè®¾ç½® â†’ é›†æˆ â†’ æ·»åŠ  Home Assistant
2. å¤åˆ¶ç”Ÿæˆçš„ Webhook URL
3. åœ¨ Home Assistant ä¸­åˆ›å»ºè‡ªåŠ¨åŒ–ï¼Œå°†ä¼ æ„Ÿå™¨äº‹ä»¶å‘é€åˆ°æ­¤ URL
4. åœ¨ NeighborGuard ä¸­å°†ä¼ æ„Ÿå™¨åˆ†é…åˆ°å¯¹åº”çš„ Zone

---

# ç¬¬ä¹éƒ¨åˆ†ï¼šæœªæ¥è·¯çº¿å›¾

## Phase 2.5: ML é›†æˆ
- åŸºäºæ”¶é›†çš„åé¦ˆæ•°æ®è®­ç»ƒ ML æ¨¡å‹
- ç”¨ ML é¢„æµ‹æ›¿æ¢å¯å‘å¼è¯„åˆ†å™¨
- ä¸ªæ€§åŒ–é€šçŸ¥é˜ˆå€¼

## Phase 3: å¤šå®¶åº­ä¸ç¤¾åŒº
- æ”¯æŒç”¨æˆ·æ‹¥æœ‰å¤šä¸ªå®¶åº­
- ç¤¾åŒºçº§åˆ«çš„è­¦æŠ¥å…±äº«ï¼ˆå¯é€‰å‚ä¸ï¼‰
- è·¨å®¶åº­å¯ç–‘æ´»åŠ¨å…³è”

## Phase 4: é«˜çº§åŠŸèƒ½
- åŸç”Ÿ iOS/Android åº”ç”¨
- Apple HomeKit / Google Home é›†æˆ
- äººè„¸è¯†åˆ«ï¼ˆå·²çŸ¥äººå‘˜ï¼‰
- è½¦ç‰Œè¯†åˆ«
- åŒå‘éŸ³é¢‘é›†æˆ

---

# é™„å½• A: å®Œæ•´ Prisma Schema

å®Œæ•´ schema è¯·å‚è€ƒï¼š`backend/prisma/schema.prisma`

# é™„å½• B: èåˆè§„åˆ™å®Œæ•´åˆ—è¡¨

å®Œæ•´è§„åˆ™å®šä¹‰è¯·å‚è€ƒï¼š`docs/FUSION_RULES_REFERENCE.md`

# é™„å½• C: API å®Œæ•´å‚è€ƒ

å®Œæ•´ API æ–‡æ¡£è¯·å‚è€ƒï¼š`docs/API_REFERENCE.md`
